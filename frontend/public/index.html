<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>justcheckit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --green:#4caf50;
  --amber:#f5a623;
  --red:#e74c3c;
  --bg:#0f1115;
  --text:#eaeaea;
  --muted:#a0a0a0;
  --cta:#f5c400;
}

* {
  box-sizing:border-box;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
}

body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.container {
  width:100%;
  max-width:420px;
  padding:32px 20px;
  text-align:center;
}

.logo-text {
  font-size:34px;
  font-weight:700;
}

.logo-line {
  margin-top:6px;
  height:4px;
  width:100%;
  background:linear-gradient(to right,var(--green),var(--amber),var(--red));
  border-radius:2px;
}

.scanning .logo-line::before {
  content:"";
  display:block;
  height:100%;
  width:35%;
  background:inherit;
  animation:scan 2.6s linear infinite;
}

@keyframes scan {
  from { transform:translateX(-120%); }
  to   { transform:translateX(260%); }
}

.headline {
  margin-top:22px;
  font-size:18px;
}

.subtext {
  margin-top:12px;
  font-size:14px;
  color:var(--muted);
}

input {
  margin-top:22px;
  width:100%;
  padding:14px;
  font-size:16px;
  border-radius:6px;
  border:none;
}

button {
  margin-top:20px;
  width:100%;
  padding:14px;
  font-size:16px;
  font-weight:600;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

button.primary {
  background:var(--cta);
}

.card {
  margin-top:22px;
  padding:16px;
  background:#161922;
  border-radius:10px;
  text-align:left;
}

.disclaimer {
  margin-top:18px;
  font-size:12px;
  color:#7d7d7d;
}
</style>
</head>

<body>
<div class="container" id="app"></div>

<script>
let step = 1;
let identifier = "";
let identifier_type = "email";
let checkReport = null;
let paymentRef = null;

const app = document.getElementById("app");

const scanMessages = [
  "Scanning available information",
  "Reviewing reported patterns",
  "Checking reference history"
];

function render() {
  app.className = "container";

  if (step === 1) {
    app.innerHTML = `
      <div class="logo-text">justcheckit</div>
      <div class="logo-line"></div>

      <div class="headline">Before you pay — check first</div>
      <div class="subtext">A fast, private check for early warning signs.</div>

      <input id="input" placeholder="Email, phone, or reference" />
      <button class="primary" onclick="runCheck()">Check now</button>

      <div class="disclaimer">Information only · No judgments</div>
    `;
  }

  if (step === 2) {
    app.classList.add("scanning");
    let i = 0;

    app.innerHTML = `
      <div class="logo-text">justcheckit</div>
      <div class="logo-line"></div>
      <div class="headline" id="scanText">${scanMessages[0]}</div>
    `;

    const interval = setInterval(() => {
      i = (i + 1) % scanMessages.length;
      document.getElementById("scanText").innerText = scanMessages[i];
    }, 1800);

    setTimeout(() => {
      clearInterval(interval);
      step = 3;
      render();
    }, 5200);
  }

  if (step === 3 && checkReport) {
    app.innerHTML = `
      <div class="logo-text">justcheckit</div>
      <div class="logo-line"></div>

      <div class="headline">${checkReport.headline}</div>
      <div class="subtext">Unlock the full explanation.</div>

      <button class="primary" onclick="startPayment()">Unlock full check</button>
      <div class="disclaimer">$1.49 · one-time</div>
    `;
  }

  if (step === 4) {
    app.innerHTML = `
      <div class="logo-text">justcheckit</div>
      <div class="logo-line"></div>

      <div class="headline">Processing payment…</div>
      <div class="subtext">Finalising your report</div>
    `;
  }

  if (step === 5 && checkReport) {
    app.innerHTML = `
      <div class="logo-text">justcheckit</div>
      <div class="logo-line"></div>

      <div class="headline">${checkReport.headline}</div>

      <div class="card">
        <strong>Confidence:</strong> ${checkReport.confidence}<br><br>
        <strong>Indicators:</strong>
        <ul>
          ${(checkReport.indicators || []).map(i => `<li>${i}</li>`).join("") || "<li>No indicators</li>"}
        </ul>
      </div>

      <button class="primary" onclick="restart()">Run another check</button>

      <div class="disclaimer">
        Informational only · Not advice or conclusions
      </div>
    `;
  }
}

async function runCheck() {
  const value = document.getElementById("input").value.trim();
  if (!value) return alert("Enter a value");

  identifier = value;
  step = 2;
  render();

  try {
    const res = await fetch("/check", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ identifier, identifier_type })
    });

    const data = await res.json();
    checkReport = data.report;

  } catch {
    alert("Check failed");
    step = 1;
    render();
  }
}

async function startPayment() {
  step = 4;
  render();

  try {
    const res = await fetch("/pay/init", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ identifier, identifier_type })
    });

    const data = await res.json();

    if (!data || !data.payment || !data.payment.ref) {
      throw new Error("Missing payment ref");
    }

    paymentRef = data.payment.ref;
    await confirmPayment();

  } catch {
    alert("Payment failed");
    step = 3;
    render();
  }
}

async function confirmPayment() {
  const res = await fetch(
    `/pay/confirm?ref=${paymentRef}&identifier=${identifier}&identifier_type=${identifier_type}`
  );

  const data = await res.json();
  checkReport = data.report;
  step = 5;
  render();
}

function restart() {
  step = 1;
  identifier = "";
  checkReport = null;
  paymentRef = null;
  render();
}

render();
</script>
</body>
</html>
