<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JustCheckIt</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b0b0b;
      color: #fff;
      padding: 40px;
    }

    input, select, button {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      max-width: 400px;
    }

    button {
      cursor: pointer;
      font-weight: bold;
    }

    .report {
      margin-top: 30px;
      padding: 20px;
      border-radius: 8px;
    }

    .green { background: #0f3; color: #000; }
    .amber { background: #ffb000; color: #000; }
    .red { background: #ff3b3b; color: #000; }
  </style>
</head>

<body>

  <h1>JustCheckIt</h1>

  <select id="identifier_type">
    <option value="phone">Phone Number</option>
    <option value="business">Business Name</option>
  </select>

  <input
    id="identifier"
    placeholder="Enter identifier"
  />

  <button onclick="runCheck()">Run check</button>

  <div id="output"></div>

  <script>
    async function runCheck() {
      const identifier = document.getElementById("identifier").value;
      const identifier_type = document.getElementById("identifier_type").value;
      const output = document.getElementById("output");

      output.innerHTML = "Checking...";

      try {
        const res = await fetch("/check", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ identifier, identifier_type })
        });

        const data = await res.json();
        renderReport(data.report, false);

      } catch (err) {
        output.innerHTML = "Check failed.";
      }
    }

    async function startPayment() {
      const identifier = document.getElementById("identifier").value;
      const identifier_type = document.getElementById("identifier_type").value;
      const output = document.getElementById("output");

      output.innerHTML = "Starting payment...";

      try {
        const res = await fetch("/pay/init", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ identifier, identifier_type })
        });

        const data = await res.json();

        // MOCK CONFIRM â€” NO PAYPAL
        confirmPayment(
          data.payment.ref,
          identifier,
          identifier_type
        );

      } catch (err) {
        output.innerHTML = "Payment init failed.";
      }
    }

    async function confirmPayment(ref, identifier, identifier_type) {
      const output = document.getElementById("output");
      output.innerHTML = "Generating full report...";

      try {
        const res = await fetch(
          `/pay/confirm?ref=${encodeURIComponent(ref)}&identifier=${encodeURIComponent(identifier)}&identifier_type=${identifier_type}`
        );

        const data = await res.json();
        renderReport(data.report, true);

      } catch (err) {
        output.innerHTML = "Paid report failed.";
      }
    }

    function renderReport(report, paid) {
      const output = document.getElementById("output");

      const indicators =
        report.indicators?.length
          ? report.indicators.map(i => `<li>${i.description}</li>`).join("")
          : "<li>No indicators</li>";

      output.innerHTML = `
        <div class="report ${report.risk_color}">
          <h2>${report.headline}</h2>

          <p><strong>Identifier:</strong> ${report.identifier}</p>
          <p><strong>Confidence:</strong> ${report.confidence}</p>

          <h3>Indicators</h3>
          <ul>${indicators}</ul>

          ${
            paid
              ? `<h3>System Notes</h3>
                 <ul>${report.system_notes.map(n => `<li>${n}</li>`).join("")}</ul>`
              : `<button onclick="startPayment()">Unlock full report</button>`
          }

          <small>${report.meta.generated_at}</small>
        </div>
      `;
    }
  </script>

</body>
</html>
